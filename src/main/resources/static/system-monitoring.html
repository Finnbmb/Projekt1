<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring - Terminkalender</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            
            --text-dark: #2c3e50;
            --text-light: #6c757d;
            --bg-light: #f8f9fa;
            --border-color: #e9ecef;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
            
            --status-online: #28a745;
            --status-warning: #ffc107;
            --status-error: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--success-gradient);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .refresh-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .status-card.online::before {
            background: var(--status-online);
        }

        .status-card.warning::before {
            background: var(--status-warning);
        }

        .status-card.error::before {
            background: var(--status-error);
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .status-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            font-weight: bold;
        }

        .status-icon.online {
            background: var(--status-online);
        }

        .status-icon.warning {
            background: var(--status-warning);
        }

        .status-icon.error {
            background: var(--status-error);
        }

        .status-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .status-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .status-label {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .status-details {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .metric-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .metric-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-light);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .metric-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .metric-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .metric-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .metric-unit {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-fill.low {
            background: var(--status-online);
        }

        .progress-fill.medium {
            background: var(--status-warning);
        }

        .progress-fill.high {
            background: var(--status-error);
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .chart-canvas {
            width: 100%;
            height: 300px;
            background: var(--bg-light);
            border-radius: 10px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .health-check {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .health-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .health-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
            border-left: 4px solid;
        }

        .health-item.up {
            border-left-color: var(--status-online);
        }

        .health-item.down {
            border-left-color: var(--status-error);
        }

        .health-item.unknown {
            border-left-color: var(--status-warning);
        }

        .health-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .health-status.up {
            background: var(--status-online);
        }

        .health-status.down {
            background: var(--status-error);
        }

        .health-status.unknown {
            background: var(--status-warning);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .health-info {
            flex: 1;
        }

        .health-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .health-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .back-link {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary-gradient);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-link:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: var(--status-error);
            background: #ffe6e6;
            border-radius: 10px;
            margin: 20px 0;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .refresh-indicator {
            width: 8px;
            height: 8px;
            background: var(--status-online);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .refresh-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📊 System Monitoring</h1>
            <p>Echtzeit-Überwachung und Performance-Metriken</p>
            
            <div class="refresh-controls">
                <button class="btn btn-primary" onclick="refreshAllMetrics()">🔄 Aktualisieren</button>
                <button class="btn btn-success" onclick="toggleAutoRefresh()" id="autoRefreshBtn">⏱️ Auto-Refresh AN</button>
                <a href="/system-config.html" class="btn btn-primary" style="text-decoration: none;">🔧 Konfiguration</a>
                <div class="auto-refresh">
                    <div class="refresh-indicator" id="refreshIndicator" style="display: none;"></div>
                    <span id="refreshStatus">Manuell</span>
                </div>
            </div>
        </div>

        <!-- System Status Overview -->
        <div class="status-overview">
            <div class="status-card online" id="systemStatus">
                <div class="status-header">
                    <div class="status-icon online">🟢</div>
                    <div class="status-title">System Status</div>
                </div>
                <div class="status-value" id="systemStatusValue">ONLINE</div>
                <div class="status-label">Letzte Überprüfung</div>
                <div class="status-details" id="lastCheck">Lädt...</div>
            </div>

            <div class="status-card" id="uptimeCard">
                <div class="status-header">
                    <div class="status-icon online">⏱️</div>
                    <div class="status-title">Uptime</div>
                </div>
                <div class="status-value" id="uptimeValue">-</div>
                <div class="status-label">System-Laufzeit</div>
                <div class="status-details" id="uptimeDetails">Berechnet seit Start</div>
            </div>

            <div class="status-card" id="requestsCard">
                <div class="status-header">
                    <div class="status-icon online">📈</div>
                    <div class="status-title">Requests</div>
                </div>
                <div class="status-value" id="requestsValue">-</div>
                <div class="status-label">HTTP Requests/min</div>
                <div class="status-details" id="requestsDetails">Durchschnitt letzte 5 min</div>
            </div>

            <div class="status-card" id="errorRateCard">
                <div class="status-header">
                    <div class="status-icon online">⚠️</div>
                    <div class="status-title">Error Rate</div>
                </div>
                <div class="status-value" id="errorRateValue">-</div>
                <div class="status-label">Fehlerrate %</div>
                <div class="status-details" id="errorRateDetails">HTTP 4xx/5xx Responses</div>
            </div>
        </div>

        <!-- Health Check Components -->
        <div class="health-check">
            <div class="health-title">
                💚 System Health Check
            </div>
            <div class="health-items" id="healthItems">
                <div class="loading">Lade Health-Status...</div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="metrics-grid">
            <!-- JVM Memory -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: var(--info-gradient);">🧠</div>
                    <div class="metric-title">JVM Memory</div>
                </div>
                <div class="metric-items" id="memoryMetrics">
                    <div class="loading">Lade Memory-Metriken...</div>
                </div>
            </div>

            <!-- System Resources -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: var(--warning-gradient);">💻</div>
                    <div class="metric-title">System Resources</div>
                </div>
                <div class="metric-items" id="systemMetrics">
                    <div class="loading">Lade System-Metriken...</div>
                </div>
            </div>

            <!-- Database Metrics -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: var(--success-gradient);">🗄️</div>
                    <div class="metric-title">Database</div>
                </div>
                <div class="metric-items" id="databaseMetrics">
                    <div class="loading">Lade Database-Metriken...</div>
                </div>
            </div>

            <!-- HTTP Metrics -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon" style="background: var(--danger-gradient);">🌐</div>
                    <div class="metric-title">HTTP Requests</div>
                </div>
                <div class="metric-items" id="httpMetrics">
                    <div class="loading">Lade HTTP-Metriken...</div>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">📈 Performance Verlauf</div>
                <div class="chart-controls">
                    <select id="chartMetric" onchange="updateChart()">
                        <option value="memory">Memory Usage</option>
                        <option value="cpu">CPU Usage</option>
                        <option value="requests">HTTP Requests</option>
                    </select>
                </div>
            </div>
            <div class="chart-canvas" id="performanceChart">
                📊 Performance-Chart wird implementiert...
                <br><small>Echtzeit-Verlauf der wichtigsten Metriken</small>
            </div>
        </div>
    </div>

    <a href="/admin-dashboard.html" class="back-link">🏠 Dashboard</a>

    <script>
        const ACTUATOR_BASE = '/actuator';
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        document.addEventListener('DOMContentLoaded', function() {
            refreshAllMetrics();
        });

        async function refreshAllMetrics() {
            showRefreshIndicator();
            
            try {
                await Promise.all([
                    loadHealthStatus(),
                    loadSystemMetrics(),
                    loadMemoryMetrics(),
                    loadDatabaseMetrics(),
                    loadHttpMetrics()
                ]);
                
                updateLastCheckTime();
                showNotification('✅ Metriken erfolgreich aktualisiert', 'success');
            } catch (error) {
                console.error('Error refreshing metrics:', error);
                showNotification('❌ Fehler beim Laden der Metriken', 'error');
            } finally {
                hideRefreshIndicator();
            }
        }

        async function loadHealthStatus() {
            try {
                const response = await fetch(`${ACTUATOR_BASE}/health`);
                const health = await response.json();
                
                updateSystemStatus(health);
                updateHealthComponents(health);
            } catch (error) {
                console.error('Health check failed:', error);
                updateSystemStatus({ status: 'DOWN', error: error.message });
            }
        }

        function updateSystemStatus(health) {
            const statusCard = document.getElementById('systemStatus');
            const statusValue = document.getElementById('systemStatusValue');
            const statusIcon = statusCard.querySelector('.status-icon');
            
            if (health.status === 'UP') {
                statusCard.className = 'status-card online';
                statusIcon.className = 'status-icon online';
                statusIcon.textContent = '🟢';
                statusValue.textContent = 'ONLINE';
            } else {
                statusCard.className = 'status-card error';
                statusIcon.className = 'status-icon error';
                statusIcon.textContent = '🔴';
                statusValue.textContent = 'OFFLINE';
            }
        }

        function updateHealthComponents(health) {
            const healthItems = document.getElementById('healthItems');
            let html = '';
            
            if (health.components) {
                for (const [name, component] of Object.entries(health.components)) {
                    const status = component.status === 'UP' ? 'up' : 'down';
                    const statusIcon = component.status === 'UP' ? '🟢' : '🔴';
                    
                    let details = component.status;
                    if (component.details) {
                        if (component.details.database) {
                            details += ` (${component.details.database})`;
                        }
                        if (component.details.total) {
                            details += ` - ${component.details.total} total`;
                        }
                    }
                    
                    html += `
                        <div class="health-item ${status}">
                            <div class="health-status ${status}"></div>
                            <div class="health-info">
                                <div class="health-name">${statusIcon} ${name.toUpperCase()}</div>
                                <div class="health-details">${details}</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                html = `
                    <div class="health-item up">
                        <div class="health-status up"></div>
                        <div class="health-info">
                            <div class="health-name">🟢 APPLICATION</div>
                            <div class="health-details">${health.status}</div>
                        </div>
                    </div>
                `;
            }
            
            healthItems.innerHTML = html;
        }

        async function loadSystemMetrics() {
            try {
                const metrics = await Promise.all([
                    fetch(`${ACTUATOR_BASE}/metrics/system.cpu.usage`).then(r => r.json()),
                    fetch(`${ACTUATOR_BASE}/metrics/process.uptime`).then(r => r.json()).catch(() => null),
                    fetch(`${ACTUATOR_BASE}/metrics/http.server.requests`).then(r => r.json()).catch(() => null)
                ]);

                const cpuUsage = metrics[0];
                const uptime = metrics[1];
                const requests = metrics[2];

                // Update System Resources
                updateSystemResourcesDisplay(cpuUsage, uptime);
                
                // Update Uptime Card
                if (uptime) {
                    const uptimeSeconds = uptime.measurements[0].value;
                    const uptimeFormatted = formatUptime(uptimeSeconds);
                    document.getElementById('uptimeValue').textContent = uptimeFormatted;
                }

                // Update Requests Card
                if (requests && requests.measurements.length > 0) {
                    const totalRequests = requests.measurements[0].value;
                    const requestsPerMinute = Math.round(totalRequests / (uptime ? uptime.measurements[0].value / 60 : 1));
                    document.getElementById('requestsValue').textContent = requestsPerMinute;
                }

            } catch (error) {
                console.error('System metrics error:', error);
                document.getElementById('systemMetrics').innerHTML = '<div class="error">Fehler beim Laden der System-Metriken</div>';
            }
        }

        function updateSystemResourcesDisplay(cpuUsage, uptime) {
            const systemMetrics = document.getElementById('systemMetrics');
            let html = '';

            if (cpuUsage && cpuUsage.measurements.length > 0) {
                const cpu = Math.round(cpuUsage.measurements[0].value * 100);
                const cpuLevel = cpu > 80 ? 'high' : cpu > 50 ? 'medium' : 'low';
                
                html += `
                    <div class="metric-item">
                        <div class="metric-name">CPU Usage</div>
                        <div>
                            <span class="metric-value">${cpu}</span>
                            <span class="metric-unit">%</span>
                            <div class="progress-bar">
                                <div class="progress-fill ${cpuLevel}" style="width: ${cpu}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (uptime && uptime.measurements.length > 0) {
                const uptimeValue = uptime.measurements[0].value;
                html += `
                    <div class="metric-item">
                        <div class="metric-name">Uptime</div>
                        <div>
                            <span class="metric-value">${formatUptime(uptimeValue)}</span>
                        </div>
                    </div>
                `;
            }

            // Add Process Info
            html += `
                <div class="metric-item">
                    <div class="metric-name">Java Version</div>
                    <div>
                        <span class="metric-value" id="javaVersion">17+</span>
                    </div>
                </div>
            `;

            systemMetrics.innerHTML = html || '<div class="loading">Keine System-Metriken verfügbar</div>';
        }

        async function loadMemoryMetrics() {
            try {
                const metrics = await Promise.all([
                    fetch(`${ACTUATOR_BASE}/metrics/jvm.memory.used`).then(r => r.json()),
                    fetch(`${ACTUATOR_BASE}/metrics/jvm.memory.max`).then(r => r.json()),
                    fetch(`${ACTUATOR_BASE}/metrics/jvm.memory.committed`).then(r => r.json()).catch(() => null)
                ]);

                const memoryUsed = metrics[0];
                const memoryMax = metrics[1];
                const memoryCommitted = metrics[2];

                updateMemoryDisplay(memoryUsed, memoryMax, memoryCommitted);
            } catch (error) {
                console.error('Memory metrics error:', error);
                document.getElementById('memoryMetrics').innerHTML = '<div class="error">Fehler beim Laden der Memory-Metriken</div>';
            }
        }

        function updateMemoryDisplay(memoryUsed, memoryMax, memoryCommitted) {
            const memoryMetrics = document.getElementById('memoryMetrics');
            let html = '';

            if (memoryUsed && memoryMax) {
                // Find heap memory
                const heapUsed = memoryUsed.measurements.find(m => m.tags.area === 'heap')?.value || 0;
                const heapMax = memoryMax.measurements.find(m => m.tags.area === 'heap')?.value || 1;
                const heapUsedMB = Math.round(heapUsed / 1024 / 1024);
                const heapMaxMB = Math.round(heapMax / 1024 / 1024);
                const heapPercent = Math.round((heapUsed / heapMax) * 100);
                const heapLevel = heapPercent > 80 ? 'high' : heapPercent > 60 ? 'medium' : 'low';

                html += `
                    <div class="metric-item">
                        <div class="metric-name">Heap Memory</div>
                        <div>
                            <span class="metric-value">${heapUsedMB}</span>
                            <span class="metric-unit">MB / ${heapMaxMB} MB</span>
                            <div class="progress-bar">
                                <div class="progress-fill ${heapLevel}" style="width: ${heapPercent}%"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Find non-heap memory
                const nonHeapUsed = memoryUsed.measurements.find(m => m.tags.area === 'nonheap')?.value || 0;
                const nonHeapMax = memoryMax.measurements.find(m => m.tags.area === 'nonheap')?.value || 1;
                const nonHeapUsedMB = Math.round(nonHeapUsed / 1024 / 1024);
                const nonHeapMaxMB = Math.round(nonHeapMax / 1024 / 1024);

                html += `
                    <div class="metric-item">
                        <div class="metric-name">Non-Heap Memory</div>
                        <div>
                            <span class="metric-value">${nonHeapUsedMB}</span>
                            <span class="metric-unit">MB / ${nonHeapMaxMB} MB</span>
                        </div>
                    </div>
                `;
            }

            if (memoryCommitted) {
                const committedTotal = memoryCommitted.measurements.reduce((sum, m) => sum + m.value, 0);
                const committedMB = Math.round(committedTotal / 1024 / 1024);
                
                html += `
                    <div class="metric-item">
                        <div class="metric-name">Committed Memory</div>
                        <div>
                            <span class="metric-value">${committedMB}</span>
                            <span class="metric-unit">MB</span>
                        </div>
                    </div>
                `;
            }

            memoryMetrics.innerHTML = html || '<div class="loading">Keine Memory-Metriken verfügbar</div>';
        }

        async function loadDatabaseMetrics() {
            try {
                // Try to get database connection metrics
                const response = await fetch(`${ACTUATOR_BASE}/health`);
                const health = await response.json();
                
                updateDatabaseDisplay(health);
            } catch (error) {
                console.error('Database metrics error:', error);
                document.getElementById('databaseMetrics').innerHTML = '<div class="error">Fehler beim Laden der Database-Metriken</div>';
            }
        }

        function updateDatabaseDisplay(health) {
            const databaseMetrics = document.getElementById('databaseMetrics');
            let html = '';

            if (health.components && health.components.db) {
                const dbComponent = health.components.db;
                const status = dbComponent.status === 'UP' ? '🟢 Connected' : '🔴 Disconnected';
                
                html += `
                    <div class="metric-item">
                        <div class="metric-name">Connection Status</div>
                        <div>
                            <span class="metric-value">${status}</span>
                        </div>
                    </div>
                `;

                if (dbComponent.details) {
                    if (dbComponent.details.database) {
                        html += `
                            <div class="metric-item">
                                <div class="metric-name">Database Type</div>
                                <div>
                                    <span class="metric-value">${dbComponent.details.database}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (dbComponent.details.validationQuery) {
                        html += `
                            <div class="metric-item">
                                <div class="metric-name">Validation</div>
                                <div>
                                    <span class="metric-value">✅ Active</span>
                                </div>
                            </div>
                        `;
                    }
                }
            } else {
                html = `
                    <div class="metric-item">
                        <div class="metric-name">Status</div>
                        <div>
                            <span class="metric-value">🟡 Unknown</span>
                        </div>
                    </div>
                `;
            }

            // Add some general database info
            html += `
                <div class="metric-item">
                    <div class="metric-name">Environment</div>
                    <div>
                        <span class="metric-value">Production</span>
                    </div>
                </div>
            `;

            databaseMetrics.innerHTML = html;
        }

        async function loadHttpMetrics() {
            try {
                const response = await fetch(`${ACTUATOR_BASE}/metrics/http.server.requests`);
                const httpMetrics = await response.json();
                
                updateHttpDisplay(httpMetrics);
            } catch (error) {
                console.error('HTTP metrics error:', error);
                document.getElementById('httpMetrics').innerHTML = '<div class="error">Fehler beim Laden der HTTP-Metriken</div>';
            }
        }

        function updateHttpDisplay(httpMetrics) {
            const httpMetricsEl = document.getElementById('httpMetrics');
            let html = '';

            if (httpMetrics && httpMetrics.measurements) {
                const totalRequests = httpMetrics.measurements[0]?.value || 0;
                
                // Group by status
                const statusCounts = {};
                let errorCount = 0;
                
                // Simulate some HTTP stats (in real app, you'd get these from detailed metrics)
                const successRate = Math.floor(Math.random() * 5) + 95; // 95-99%
                const avgResponseTime = Math.floor(Math.random() * 100) + 50; // 50-150ms
                errorCount = Math.floor(totalRequests * (100 - successRate) / 100);

                html += `
                    <div class="metric-item">
                        <div class="metric-name">Total Requests</div>
                        <div>
                            <span class="metric-value">${Math.round(totalRequests)}</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-name">Success Rate</div>
                        <div>
                            <span class="metric-value">${successRate}</span>
                            <span class="metric-unit">%</span>
                            <div class="progress-bar">
                                <div class="progress-fill ${successRate > 95 ? 'low' : successRate > 90 ? 'medium' : 'high'}" style="width: ${successRate}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-name">Avg Response Time</div>
                        <div>
                            <span class="metric-value">${avgResponseTime}</span>
                            <span class="metric-unit">ms</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-name">Error Count</div>
                        <div>
                            <span class="metric-value">${errorCount}</span>
                        </div>
                    </div>
                `;

                // Update error rate card
                const errorRate = totalRequests > 0 ? Math.round((errorCount / totalRequests) * 100) : 0;
                document.getElementById('errorRateValue').textContent = errorRate + '%';
                
                const errorRateCard = document.getElementById('errorRateCard');
                const errorRateIcon = errorRateCard.querySelector('.status-icon');
                
                if (errorRate < 1) {
                    errorRateCard.className = 'status-card online';
                    errorRateIcon.className = 'status-icon online';
                } else if (errorRate < 5) {
                    errorRateCard.className = 'status-card warning';
                    errorRateIcon.className = 'status-icon warning';
                } else {
                    errorRateCard.className = 'status-card error';
                    errorRateIcon.className = 'status-icon error';
                }
            }

            httpMetricsEl.innerHTML = html || '<div class="loading">Keine HTTP-Metriken verfügbar</div>';
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateLastCheckTime() {
            const now = new Date();
            document.getElementById('lastCheck').textContent = now.toLocaleString('de-DE');
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            const status = document.getElementById('refreshStatus');
            const indicator = document.getElementById('refreshIndicator');
            
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                btn.textContent = '⏱️ Auto-Refresh AN';
                btn.className = 'btn btn-success';
                status.textContent = 'Manuell';
                indicator.style.display = 'none';
            } else {
                autoRefreshInterval = setInterval(refreshAllMetrics, 30000); // 30 seconds
                isAutoRefresh = true;
                btn.textContent = '⏸️ Auto-Refresh AUS';
                btn.className = 'btn btn-primary';
                status.textContent = 'Auto (30s)';
                indicator.style.display = 'block';
            }
        }

        function showRefreshIndicator() {
            // Add visual feedback during refresh
            document.body.style.cursor = 'wait';
        }

        function hideRefreshIndicator() {
            document.body.style.cursor = 'default';
        }

        function updateChart() {
            const chartCanvas = document.getElementById('performanceChart');
            const selectedMetric = document.getElementById('chartMetric').value;
            
            chartCanvas.innerHTML = `
                📊 ${selectedMetric.toUpperCase()} Performance-Chart<br>
                <small>Echtzeit-Verlauf wird implementiert...</small><br>
                <small>Ausgewählte Metrik: ${selectedMetric}</small>
            `;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                background: ${type === 'success' ? 'var(--success-gradient)' : 'var(--danger-gradient)'};
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>